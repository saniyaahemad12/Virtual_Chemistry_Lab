<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Dashboard â€“ Virtual Chemistry Lab</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.12.0/lottie.min.js"></script>

<style>
/* ================= GLOBAL ================= */
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', sans-serif;
  background: linear-gradient(to right, #e3f2fd, #ffffff);
  color: #0d47a1;
}

/* ================= HEADER ================= */
header {
  background: linear-gradient(to right, #1e3c72, #2a5298);
  padding: 25px 20px;
  color: #fff;
  text-align: center;
}

.header-container {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
}

.labman-logo {
  width: 60px;
  height: 60px;
  border-radius: 50%;
}

nav {
  margin-top: 15px;
}

nav a {
  color: #fff;
  text-decoration: none;
  padding: 8px 16px;
  margin: 0 5px;
  border-radius: 6px;
  background: rgba(255,255,255,0.15);
  transition: 0.3s;
}

nav a.active,
nav a:hover {
  background: #1976d2;
}

/* ================= SECTIONS ================= */
.section {
  display: none;
  padding: 40px 20px;
}

.section.active {
  display: block;
}

/* ================= CONTAINER ================= */
.dashboard-container {
  max-width: 1000px;
  margin: auto;
}

/* ================= FORMS ================= */
label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
}

input, select, textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 14px;
  border-radius: 8px;
  border: 1px solid #b3c6e0;
}

.assign-btn {
  background: #1976d2;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 10px 20px;
  cursor: pointer;
  font-weight: 600;
}

.assign-btn.danger {
  background: #d32f2f;
}

.status-msg {
  margin-top: 10px;
  font-weight: 600;
}

/* ================= TABLE ================= */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #ddd;
  padding: 10px;
}

th {
  background: #bbdefb;
}

/* ================= MODALS ================= */
.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 2000;
}

.modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 600px;
}

.manage-students-container {
  margin-top: 20px;
}

.registered-students {
  margin-bottom: 20px;
}

.clear-data {
  text-align: right;
}

.close-btn {
  background: none;
  border: none;
  color: #1976d2;
  cursor: pointer;
  font-size: 16px;
  margin-bottom: 10px;
}
</style>
</head>

<body>

<header>
  <div class="header-container">
    <img src="../assets/labman.png" class="labman-logo">
    <h1>Virtual Chemistry Lab</h1>
  </div>
  <nav>
    <a href="index.html" class="active">Home</a>
    <a href="#students">Manage Students</a>
    <a href="#assign">Assign Tasks</a>
    <a href="#evaluate">Evaluate</a>
  </nav>
</header>

<div class="dashboard-container">

<!-- HOME -->
<div class="section active" id="home">
  <h2>Welcome Teacher ðŸ‘‹</h2>
  <p>Use the menu to manage students, assignments and evaluations.</p>
</div>

<!-- STUDENTS -->
<div class="section" id="students">
  <h2>Manage Students</h2>

  <div class="manage-students-container" style="display: flex; gap: 20px;">
    <!-- Registered Students List -->
    <div class="registered-students" style="flex: 1; background: #f8f9fa; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
      <h4 style="color: #0d47a1; margin-bottom: 15px;">Registered Students</h4>
      <ul id="registered-students" style="list-style: none; padding: 0;">
        <!-- Registered students will be dynamically loaded here -->
      </ul>
    </div>

    <!-- Add Student Form -->
    <div class="add-student-form" style="flex: 1; background: #e3f2fd; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);">
      <h4 style="color: #0d47a1; margin-bottom: 15px;">Add Student</h4>
      <form id="student-info-form">
        <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #0d47a1;">Student Name:
          <input type="text" id="student-info-name" placeholder="e.g. John Doe" required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #b3c6e0; border-radius: 8px; font-size: 1em; background: #ffffff;" />
        </label>
        <label style="display: block; font-weight: 500; margin-bottom: 8px; color: #0d47a1;">Email id:
          <input type="text" id="student-info-email" placeholder=" " required style="width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #b3c6e0; border-radius: 8px; font-size: 1em; background: #ffffff;" />
        </label>
        <button type="submit" class="assign-btn" style="background: #1976d2; color: #ffffff; border: none; border-radius: 8px; padding: 10px 20px; font-size: 1em; cursor: pointer; font-weight: 600; transition: background 0.3s ease, transform 0.2s ease;">Add Student</button>
      </form>
      <div id="student-info-status" class="status-msg" style="margin-top: 15px; color: #388e3c; font-weight: 600; text-align: center;"></div>
    </div>
  </div>
  <div class="clear-data" style="margin-top: 20px; text-align: center;">
    <button onclick="clearStudents()" class="assign-btn" style="background: #d32f2f; color: #ffffff; border: none; border-radius: 8px; padding: 10px 20px; font-size: 1em; cursor: pointer; font-weight: 600; transition: background 0.3s ease;">Clear All Students</button>
  </div>

  <!-- Student Profile Modal -->
  <div id="student-profile-modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); justify-content: center; align-items: center;">
    <div id="student-profile-content" style="background: #ffffff; border-radius: 12px; padding: 20px; max-width: 500px; width: 90%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25); text-align: center;">
      <button class="close-btn" onclick="closeStudentProfile()" style="background: #d32f2f; color: #ffffff; border: none; border-radius: 6px; padding: 8px 16px; font-size: 1em; cursor: pointer; margin-bottom: 20px;">Close</button>
      <h3 id="student-profile-name" style="color: #0d47a1; margin-bottom: 20px;">Student Name</h3>
      <p id="student-profile-email" style="font-size: 1.1em; color: #424242;">Student Email</p>
      <h4 style="color: #0d47a1; margin-bottom: 15px;">Assignments</h4>
      <table id="student-assignments-table" style="width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; border-radius: 10px; overflow: hidden; font-size: 0.95em; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);">
        <thead>
          <tr>
            <th style="border: 1px solid #e0e0e0; padding: 12px 10px; text-align: left; background: #bbdefb; color: #0d47a1; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Assignment</th>
            <th style="border: 1px solid #e0e0e0; padding: 12px 10px; text-align: left; background: #bbdefb; color: #0d47a1; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Status</th>
            <th style="border: 1px solid #e0e0e0; padding: 12px 10px; text-align: left; background: #bbdefb; color: #0d47a1; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Score</th>
          </tr>
        </thead>
        <tbody>
          <!-- Assignments will be dynamically loaded here -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ASSIGN -->
<div class="section" id="assign">
  <h2>Assign Task</h2>

  <form id="assign-form">
    <label>Student Emails (comma separated)</label>
    <input id="assign-emails" required>

    <label>Type</label>
    <select id="assign-type">
      <option value="experiment">Experiment</option>
      <option value="quiz">Quiz</option>
    </select>

    <label>Title</label>
    <input id="assign-title" required>

    <label>Instructions / Link</label>
    <input id="assign-info" required>

    <button class="assign-btn">Assign</button>
  </form>

  <div id="assign-status" class="status-msg"></div>
</div>

<!-- EVALUATE -->
<div class="section" id="evaluate">
  <h2>Evaluate Submissions</h2>
  <table>
    <thead>
      <tr>
        <th>Student</th>
        <th>Type</th>
        <th>Title</th>
        <th>Info</th>
        <th>Result</th>
      </tr>
    </thead>
    <tbody id="assignment-table"></tbody>
  </table>

  <button class="assign-btn danger" onclick="clearAssignments()">Clear All</button>
</div>

</div>

<script>
/* ================= NAVIGATION ================= */
document.addEventListener('DOMContentLoaded', () => {
  const token = localStorage.getItem('token');

  // Identify elements to hide/show
  const loginSection = document.getElementById('login-section');  // If you have a login div
  const dashboardSection = document.querySelector('.dashboard-container');

  if (token) {
    // User is logged in
    if (loginSection) loginSection.style.display = 'none';
    if (dashboardSection) dashboardSection.style.display = 'block';

    // Optional: preload dashboard data
    loadTeacherAssignments();
    loadStudents();
  } else {
    // Not logged in
    if (loginSection) loginSection.style.display = 'block';
    if (dashboardSection) dashboardSection.style.display = 'none';
  }

  // Existing navigation setup
  document.querySelectorAll('nav a').forEach(link => {
    link.addEventListener('click', e => {
      if (!link.hash) return;
      const section = document.querySelector(link.hash);
      if (!section) return;
      e.preventDefault();

      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('nav a').forEach(n => n.classList.remove('active'));

      section.classList.add('active');
      link.classList.add('active');
    });
  });
});



/* ================= STUDENTS ================= */

// ADD STUDENT (DB)
const studentForm = document.getElementById('student-info-form');
if (studentForm) {
  studentForm.onsubmit = async function (e) {
    e.preventDefault();

    const name = document.getElementById('student-info-name')?.value.trim();
    const email = document.getElementById('student-info-email')?.value.trim();
    const status = document.getElementById('student-info-status');

    if (!name || !email) {
      status.textContent = 'Fill all fields';
      status.style.color = 'red';
      return;
    }

    try {
      const res = await fetch('/add_student', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email })
      });

      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      status.textContent = 'Student added successfully';
      status.style.color = 'green';
      studentForm.reset();
      loadStudents();
    } catch (err) {
      status.textContent = err.message;
      status.style.color = 'red';
    }
  };
}


// LOAD STUDENTS (DB)
async function loadStudents() {
  const ul = document.getElementById('registered-students');
  if (!ul) return;

  ul.innerHTML = '<li style="text-align:center;color:#777">Loading...</li>';

  try {
    const res = await fetch('/students');
    const students = await res.json();

    ul.innerHTML = '';

    if (students.length === 0) {
      ul.innerHTML = '<li style="text-align:center;color:#777">No students registered</li>';
      return;
    }

    students.forEach(s => {
      const li = document.createElement('li');
      li.style = "background:#fff;padding:10px;margin-bottom:10px;border-radius:8px;display:flex;justify-content:space-between";

      li.innerHTML = `
        <span>${s.name} (${s.email})</span>
        <button onclick="viewStudentProfile('${s.email}')">View</button>
      `;

      ul.appendChild(li);
    });
  } catch (err) {
    ul.innerHTML = '<li style="color:red">Failed to load students</li>';
  }
}


// STUDENT PROFILE + ASSIGNMENTS (DB)
async function viewStudentProfile(email) {
  try {
    const res = await fetch(`/student_assignments/${email}`);
    const assignments = await res.json();

    document.getElementById('student-profile-name').textContent = email;
    document.getElementById('student-profile-modal').style.display = 'flex';

    const tbody = document.querySelector('#student-assignments-table tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (assignments.length === 0) {
      tbody.innerHTML = `<tr><td colspan="3" style="text-align:center">No assignments</td></tr>`;
      return;
    }

    assignments.forEach(a => {
      tbody.innerHTML += `
        <tr>
          <td>${a.title}</td>
          <td>${a.result ? 'Submitted' : 'Pending'}</td>
          <td>${a.result || 'N/A'}</td>
        </tr>
      `;
    });
  } catch (err) {
    alert('Failed to load student profile');
  }
}

function closeStudentProfile() {
  document.getElementById('student-profile-modal').style.display = 'none';
}


/* ================= ASSIGNMENTS ================= */

// CREATE ASSIGNMENT (DB)
const assignForm = document.getElementById('assign-form');
if (assignForm) {
  assignForm.onsubmit = async (e) => {
    e.preventDefault();

    const emails = document.getElementById('assign-emails').value
      .split(',')
      .map(e => e.trim())
      .filter(e => e.length > 0);

    if (emails.length === 0) {
      alert('Please enter at least one student email');
      return;
    }

    const assignmentType = document.getElementById('assign-type').value;
    const title = document.getElementById('assign-title').value;
    const instructions = document.getElementById('assign-info').value;
    const token = localStorage.getItem('token');
if (!token) {
  alert("You are not logged in");
  return;
}

    // âœ… CREATE LIST OF ASSIGNMENTS (THIS IS THE KEY FIX)
    const assignments = emails.map(email => ({
     // or from token
      student_email: email,
      assignment_type: assignmentType,
      title: title,
      instructions: instructions
    }));

    try {
      const res = await fetch('/create-assignment', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': `Bearer ${localStorage.getItem('token')}`
  },
  body: JSON.stringify(assignments)
});
 

      const data = await res.json();
      if (!res.ok) throw new Error(data.error);

      alert('Assignments created successfully');
      assignForm.reset();
      loadTeacherAssignments();

    } catch (err) {
      alert(err.message);
    }
  };
}


// LOAD TEACHER ASSIGNMENTS (DB)
async function loadTeacherAssignments() {
  const tableBody = document.getElementById('assignment-table');
  if (!tableBody) return;

  try {
    const res = await fetch('/teacher_assignments', {
      headers: { Authorization: `Bearer ${localStorage.getItem('token')}` }
    });

    const assignments = await res.json();
    tableBody.innerHTML = '';

    assignments.forEach(a => {
      tableBody.innerHTML += `
        <tr>
          <td>${a.student_email}</td>
          <td>${a.assignment_type}</td>
          <td>${a.title}</td>
          <td>${a.instructions}</td>
          <td>${a.result || 'Pending'}</td>
        </tr>
      `;
    });
  } catch (err) {
    tableBody.innerHTML = '<tr><td colspan="5">Failed to load</td></tr>';
  }
}


/* ================= LOGIN ================= */
async function loginTeacher(email, password) {
  try {
    const res = await fetch('/login_teacher', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    const data = await res.json();
    if (!res.ok) throw new Error(data.error);

    localStorage.setItem('token', data.token);
    alert('Login successful');
    loadTeacherAssignments();
  } catch (err) {
    alert(err.message);
  }
}

</script>

</body>
</html>
