<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Dashboard - Virtual Chemistry Lab</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(to right, #e3f2fd, #ffffff);
    color: #0d47a1;
  }

  header {
    background: linear-gradient(to right, #1e3c72, #2a5298);
    padding: 25px 20px;
    text-align: center;
    color: white;
    box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  }

  .header-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    flex-wrap: wrap;
  }

  .labman-logo {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 0 10px rgba(255,255,255,0.3);
  }

  header h1 {
    font-size: 2.2em;
  }

  nav {
    margin-top: 10px;
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 10px;
  }

  nav a {
    text-decoration: none;
    color: #ffffff;
    padding: 8px 16px;
    background-color: rgba(255,255,255,0.1);
    border-radius: 6px;
    font-weight: 500;
    transition: 0.3s;
  }

  nav a.active {
    background: #1976d2;
    color: #fff;
  }

  nav a:hover {
    background: #1565c0;
    color: #fff;
  }

  .dashboard-container {
    max-width: 1000px;
    margin: 30px auto;
    padding: 0 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .section {
    display: none;
    width: 100%;
  }

  .section.active {
    display: block;
  }

  h3, h4 {
    color: #0d47a1;
    margin-bottom: 15px;
  }

  /* Forms */
  label {
    display: block;
    font-weight: 500;
    margin-bottom: 5px;
  }

  input[type="text"], input[type="url"], textarea, select {
    width: 100%;
    padding: 10px;
    margin-bottom: 15px;
    border: 1px solid #b3c6e0;
    border-radius: 8px;
    font-size: 1em;
    background: #f7fbff;
  }

  input:focus, select:focus, textarea:focus {
    border: 1.5px solid #1976d2;
    box-shadow: 0 0 0 3px rgba(25,118,210,0.2);
    outline: none;
  }

  button {
    background: #1976d2;
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 10px 20px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.3s;
  }

  button:hover {
    background: #0d47a1;
    transform: translateY(-2px);
  }

  .status-msg { margin-top: 10px; font-weight: 500; text-align: center; }

  /* Students Section */
  .manage-students-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .registered-students, .add-student-form {
    flex: 1;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    background: #f8f9fa;
  }

  .registered-students ul {
    list-style: none;
    padding: 0;
  }

  .registered-students li {
    background: #fff;
    padding: 10px;
    margin-bottom: 10px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .registered-students li button {
    background: #1976d2;
    font-size: 0.85em;
  }

  .clear-btn { background: #d32f2f; }

  /* Assignments Table */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }

  th, td {
    border: 1px solid #e0e0e0;
    padding: 10px;
    text-align: left;
  }

  th {
    background: #bbdefb;
  }

  tr:nth-child(even) { background: #f5f5f5; }
  tr:hover { background: #e0f2f7; }

  /* Announcements */
  .announcement-form {
    background: #e3f2fd;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    margin-bottom: 20px;
  }

  .announcement-list ul {
    list-style: none;
    padding: 0;
  }

  .announcement-list li {
    background: #f8f9fa;
    padding: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  .announcement-list li strong { font-size: 1.1em; }
  .announcement-list li small { display: block; margin-top: 5px; color: #616161; }
  .announcement-list li p { margin-top: 10px; color: #424242; }
</style>
</head>
<body>

<header>
  <div class="header-container">
    <img src="../assets/labman.png" alt="Labman" class="labman-logo">
    <h1>Virtual Chemistry Lab</h1>
  </div>
  <nav>
    <a href="index.html">Home</a>
    <a href="#section-students">Manage Students</a>
    <a href="#section-assign">Assign Tasks</a>
    <a href="#section-evaluate">Evaluate Submissions</a>
    <a href="#section-announcements">Announcements</a>
  </nav>
</header>
<div class="dashboard-container">
  <!-- Home -->
  <div class="section active" id="section-home">
    <h1>Welcome to the Teacher Dashboard</h1>
    <p>Use the navigation menu to manage students, assign tasks, and evaluate submissions.</p>
  </div>
  <!-- Students -->
  <div class="section" id="section-students">
    <h3>Manage Students</h3>
    <div class="manage-students-container">
      <div class="registered-students">
        <h4>Registered Students</h4>
        <ul id="registered-students"></ul>
      </div>
      <div class="add-student-form">
        <h4>Add Student</h4>
        <form id="student-info-form">
          <label>Name:</label>
          <input type="text" id="student-info-name" placeholder="John Doe" required>
          <label>Email:</label>
          <input type="text" id="student-info-email" placeholder="email@example.com" required>
          <button type="submit">Add Student</button>
        </form>
        <div id="student-info-status" class="status-msg"></div>
      </div>
    </div>
    <button onclick="clearStudents()" class="clear-btn">Clear All Students</button>
  </div>
  <!-- Student Profile Modal -->
<div id="student-profile-modal" style="display: none;">
  <div id="student-profile-content">
    <button class="close-btn" onclick="closeStudentProfile()">Close</button>
    <h3 id="student-profile-name"></h3>
    <p id="student-profile-email"></p>
    <h4>Assignments</h4>
    <table id="student-assignments-table">
      <thead>
        <tr>
          <th>Assignment</th>
          <th>Status</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody>
        <!-- Assignments will be dynamically loaded here -->
      </tbody>
    </table>
  </div>
</div>

  <!-- Assign Tasks -->
  <div class="section" id="section-assign">
    <h3>Assign Quiz or Experiment</h3>
    <form id="assign-form">
      <label>Student Emails (comma separated)</label>
      <input type="text" id="assign-student-emails" required>
      <label>Assignment Type</label>
      <select id="assignment-type">
        <option value="experiment">Experiment</option>
        <option value="quiz">Quiz</option>
      </select>
      <div id="experiment-fields">
        <label>Experiment Name</label>
        <input type="text" id="experiment-name">
        <label>Instructions</label>
        <input type="text" id="experiment-instructions">
      </div>
      <div id="quiz-fields" style="display:none;">
        <label>Quiz Title</label>
        <input type="text" id="quiz-title">
        <label>Google Form Link</label>
        <input type="url" id="quiz-link">
      </div>
      <button type="submit">Assign</button>
    </form>
    <div id="assign-status" class="status-msg"></div>
  </div>

  <!-- Evaluate -->
  <div class="section" id="section-evaluate">
    <h3>Evaluate Assigned Quiz/Experiment</h3>
    <table id="assigned-table">
      <thead>
        <tr>
          <th>Student</th>
          <th>Type</th>
          <th>Title</th>
          <th>Instructions/Link</th>
          <th>Submission</th>
          <th>Evaluation</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="clearAssignments()" class="clear-btn">Clear All Submissions</button>
  </div>

  <!-- Announcements -->
  <div class="section" id="section-announcements">
    <h2>ðŸ“¢ Announcements</h2>
    <form class="announcement-form" id="announcement-form">
      <label>Title</label>
      <input type="text" id="announcement-title" required>
      <label>Content</label>
      <textarea id="announcement-content" rows="4" required></textarea>
      <button type="submit">Post Announcement</button>
      <div id="announcement-status" class="status-msg"></div>
    </form>
    <div class="announcement-list">
      <h3>Recent Announcements:</h3>
      <ul id="announcement-list"></ul>
    </div>
  </div>
</div>
<script>
// ---------------- Navigation ----------------
const sections = document.querySelectorAll('.section');
const navLinks = document.querySelectorAll('nav a');

navLinks.forEach(link => {
  const href = link.getAttribute('href');
  if(href.startsWith('#')) {  // Only for internal section links
    link.addEventListener('click', e => {
      const targetId = href.replace('#','');
      e.preventDefault();
      sections.forEach(sec => sec.classList.remove('active'));
      document.getElementById(targetId).classList.add('active');
      navLinks.forEach(nav => nav.classList.remove('active'));
      link.classList.add('active');
    });
  }
});
// ---------------- Students ----------------

function loadStudents() {
  fetch("http://localhost:5000/get_students", {
    headers: {
      "Authorization": "Bearer " + localStorage.getItem("token")
    }
  })
  .then(res => res.json())
  .then(students => {
    // Ensure students is an array
    if (!Array.isArray(students)) students = [];

    const ul = document.getElementById('registered-students');
    ul.innerHTML = students.length ? '' : '<li>No students registered</li>';

    students.forEach(s => {
      const li = document.createElement('li');
      li.innerHTML = `${s.name} (${s.email})`;
      ul.appendChild(li);
    });
  })
  .catch(err => console.error("Error loading students:", err));
}

// ---------------- Assignments ----------------
function loadAssignmentsFromDB() {
  fetch("http://localhost:5000/teacher_assignments", {
    method: "GET", // Must be GET
    headers: { 
      "Authorization": "Bearer " + localStorage.getItem("token")
    }
  })
  .then(res => {
    if (!res.ok) {
      console.error("Failed to load assignments:", res.status, res.statusText);
      return [];
    }
    return res.json();
  })
  .then(assignments => {
    if (!Array.isArray(assignments)) {
      console.error("Assignments is not an array:", assignments);
      document.querySelector('#assigned-table tbody').innerHTML =
        '<tr><td colspan="6">Failed to load assignments</td></tr>';
      return;
    }

    const tbody = document.querySelector('#assigned-table tbody');
    tbody.innerHTML = assignments.length
      ? ""
      : '<tr><td colspan="6">No assignments</td></tr>';

    assignments.forEach(a => {
      const info = a.assignment_type === "experiment"
        ? a.instructions
        : `<a href="${a.instructions}" target="_blank">Quiz Link</a>`;
      tbody.innerHTML += `
        <tr>
          <td>${a.student_email}</td>
          <td>${a.assignment_type}</td>
          <td>${a.title}</td>
          <td>${info}</td>
          <td>${a.result || "Pending"}</td>
          <td>
            ${a.result ? "Evaluated" : `<button onclick="evaluate('${a.id}')">Evaluate</button>`}
          </td>
        </tr>`;
    });
  })
  .catch(err => console.error(err));
}


function evaluate(id) {
  const res = prompt('Enter evaluation');
  if (!res) return;
  fetch("http://localhost:5000/evaluate_task", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + localStorage.getItem("token")
    },
    body: JSON.stringify({ task_id: id, evaluation: res })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      alert("Evaluation saved âœ…");
      loadAssignmentsFromDB();
    } else {
      alert("Error: " + data.error);
    }
  })
  .catch(err => {
    console.error("Error evaluating assignment:", err);
    alert("Server error");
  });
}

// Assign new assignments
document.getElementById('assign-form').onsubmit = function(e) {
  e.preventDefault();

  const emails = document.getElementById('assign-student-emails').value
    .split(',')
    .map(e => e.trim())
    .filter(e => e);

  const type = document.getElementById('assignment-type').value;
  const title = type === 'experiment'
    ? document.getElementById('experiment-name').value.trim()
    : document.getElementById('quiz-title').value.trim();
  const instructions = type === 'experiment'
    ? document.getElementById('experiment-instructions').value.trim()
    : document.getElementById('quiz-link').value.trim();

  if (!emails.length || !title) return alert("Missing required fields");
const token = localStorage.getItem("token");


 fetch("http://localhost:5000/assign_experiment", {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
    "Authorization": "Bearer " + localStorage.getItem("token")
  },
  body: JSON.stringify({
    student_emails: emails,       // âœ… array of emails
    assignment_type: type,        // "experiment" or "quiz"
    title: title,                 // string
    instructions: instructions    // string
  })
})

  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert(`Assigned to ${data.assigned_to.length} students âœ…`);
      document.getElementById('assign-form').reset();
      loadAssignmentsFromDB();
    } else {
      alert("Error: " + data.error);
    }
  })
  .catch(err => {
    console.error(err);
    alert("Server error");
  });
}


// Toggle assignment fields dynamically
document.getElementById('assignment-type').onchange = function() {
  document.getElementById('experiment-fields').style.display =
    this.value === 'experiment' ? 'block' : 'none';
  document.getElementById('quiz-fields').style.display =
    this.value === 'quiz' ? 'block' : 'none';
}


// ---------------- Announcements ----------------
function loadAnnouncements() {
  const ul = document.getElementById('announcement-list');
  const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');

  ul.innerHTML = announcements.length ? '' : '<li>No announcements yet</li>';

  announcements.forEach(a => {
    const li = document.createElement('li');
    li.innerHTML = `
      <strong>${a.title}</strong>
      <small>${new Date(a.date).toLocaleString()}</small>
      <p>${a.content}</p>
    `;
    ul.appendChild(li);
  });
}

document.getElementById('announcement-form').onsubmit = function(e) {
  e.preventDefault();

  const title = document.getElementById('announcement-title').value.trim();
  const content = document.getElementById('announcement-content').value.trim();

  if (!title || !content) return alert("Both title and content are required");

  const announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
  announcements.push({ title, content, date: Date.now() });

  localStorage.setItem('announcements', JSON.stringify(announcements));
  this.reset();
  loadAnnouncements();
}

// ---------------- Initial load ----------------
loadStudents();
loadAssignmentsFromDB();
loadAnnouncements();

</script>
</body>
</html>


